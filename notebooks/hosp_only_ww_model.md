# Replicating Hospital Only Model from
`cdcgov/wastewater-informed-covid-forecasting`


``` python
import json

import jax
import jax.numpy as jnp
import numpy as np
import numpyro
import numpyro.distributions as dist
import numpyro.distributions.transforms as transforms
from pyrenew.deterministic import DeterministicVariable
from pyrenew.randomvariable import DistributionalVariable, TransformedVariable
from pyrenew_covid_wastewater.hosp_only_ww_model import (
    hosp_only_ww_model,
    create_hosp_only_ww_model_from_stan_data,
)
import pyrenew_covid_wastewater.plotting as plotting

numpyro.set_host_device_count(4)
```

## Background

This tutorial provides a demonstration of our reimplementation of “Model
2” from the [`ww-inference-model`
project](https://github.com/CDCgov/ww-inference-model). The model is
described
[here](https://github.com/CDCgov/ww-inference-model/blob/main/model_definition.md).
Stan code for the model is
[here](https://github.com/CDCgov/ww-inference-model/blob/main/inst/stan/wwinference.stan).

The model we provide is designed to be fully-compatible with the
stan_data generated in the that project. We provide the stan data used
in the `wwinference`
[vignette](https://github.com/CDCgov/ww-inference-model/blob/main/vignettes/wwinference.Rmd)
in the [`ww-inference-model`
project](https://github.com/CDCgov/ww-inference-model). The data is
available in `notebooks/data/fit_hosp_only/stan_data.json`. This data
was generated by running `notebooks/wwinference.Rmd`, which replicates
the original vignette and saves the relevant data. This script also
saves the posterior samples from the model for comparison to our own
model.

## Load Data and create Priors

We begin by loading the stan_data, converting it the correct inputs for
our model, and definitng the model.

``` python
my_hosp_only_ww_model, data_observed_hospital_admissions = (
    create_hosp_only_ww_model_from_stan_data(
        "data/fit_hosp_only/stan_data.json"
    )
)
```

# Simulate from the model

We check that we can simulate from the prior predictive

``` python
n_forecast_days = 28
prior_predictive = my_hosp_only_ww_model.prior_predictive(
    n_datapoints=len(data_observed_hospital_admissions) + n_forecast_days,
    numpyro_predictive_args={"num_samples": 200},
)
```

# Fit the model

Now we can fit the model to the observed data:

``` python
my_hosp_only_ww_model.run(
    num_warmup=500,
    num_samples=500,
    rng_key=jax.random.key(200),
    data_observed_hospital_admissions=data_observed_hospital_admissions,
    mcmc_args=dict(num_chains=4, progress_bar=False),
    nuts_args=dict(find_heuristic_step_size=True),
)
```

Check the posterior predictive and forecast:

``` python
posterior_predictive = my_hosp_only_ww_model.posterior_predictive(
    n_datapoints=len(data_observed_hospital_admissions) + n_forecast_days
)
```

## Prepare for plotting

``` python
import arviz as az

idata = az.from_numpyro(
    my_hosp_only_ww_model.mcmc,
    posterior_predictive=posterior_predictive,
    prior=prior_predictive,
)
```

## Plot Predictive Distributions

``` python
plotting.plot_predictive(idata, prior=True)
```

![](hosp_only_ww_model_files/figure-commonmark/cell-8-output-1.png)

``` python
plotting.plot_predictive(idata)
```

![](hosp_only_ww_model_files/figure-commonmark/cell-9-output-1.png)

## Plot all posteriors

``` python
for key in list(idata.posterior.keys()):
    try:
        fig = plotting.plot_posterior(idata, key)
        fig.show()
    except Exception as e:
        print(f"An error occurred while plotting {key}: {e}")
```

    An error occurred while plotting autoreg_p_hosp: "No variable named 'autoreg_p_hosp_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"
    An error occurred while plotting autoreg_rt: "No variable named 'autoreg_rt_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"
    An error occurred while plotting eta_sd: "No variable named 'eta_sd_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"
    An error occurred while plotting i0_over_n_rv: "No variable named 'i0_over_n_rv_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"
    An error occurred while plotting inf_feedback_raw: "No variable named 'inf_feedback_raw_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"
    An error occurred while plotting inv_sqrt_phi: "No variable named 'inv_sqrt_phi_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"
    An error occurred while plotting log_r_mu_intercept_rv: "No variable named 'log_r_mu_intercept_rv_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"
    An error occurred while plotting p_hosp_ar_init: "No variable named 'p_hosp_ar_init_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"
    An error occurred while plotting p_hosp_mean: "No variable named 'p_hosp_mean_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"
    An error occurred while plotting p_hosp_w_sd_sd: "No variable named 'p_hosp_w_sd_sd_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"
    An error occurred while plotting rate: "No variable named 'rate_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"
    An error occurred while plotting rt_init_rate_of_change: "No variable named 'rt_init_rate_of_change_dim_0'. Variables on the dataset include ['chain', 'draw', 'autoreg_p_hosp', 'autoreg_rt', 'eta_sd', ..., 'rt_init_rate_of_change', 'rtu_dim_0', 'rtu', 'rtu_weekly_diff_first_diff_ar_process_noise_dim_0', 'rtu_weekly_diff_first_diff_ar_process_noise']"

    /var/folders/ll/blb1cyk94l35kf64jx3d7g3r0000gn/T/ipykernel_16043/167764205.py:4: UserWarning: FigureCanvasAgg is non-interactive, and thus cannot be shown
      fig.show()
    /var/folders/ll/blb1cyk94l35kf64jx3d7g3r0000gn/T/ipykernel_16043/167764205.py:4: UserWarning: FigureCanvasAgg is non-interactive, and thus cannot be shown
      fig.show()
    /var/folders/ll/blb1cyk94l35kf64jx3d7g3r0000gn/T/ipykernel_16043/167764205.py:4: UserWarning: FigureCanvasAgg is non-interactive, and thus cannot be shown
      fig.show()
    /var/folders/ll/blb1cyk94l35kf64jx3d7g3r0000gn/T/ipykernel_16043/167764205.py:4: UserWarning: FigureCanvasAgg is non-interactive, and thus cannot be shown
      fig.show()
    /var/folders/ll/blb1cyk94l35kf64jx3d7g3r0000gn/T/ipykernel_16043/167764205.py:4: UserWarning: FigureCanvasAgg is non-interactive, and thus cannot be shown
      fig.show()
    /var/folders/ll/blb1cyk94l35kf64jx3d7g3r0000gn/T/ipykernel_16043/167764205.py:4: UserWarning: FigureCanvasAgg is non-interactive, and thus cannot be shown
      fig.show()
    /var/folders/ll/blb1cyk94l35kf64jx3d7g3r0000gn/T/ipykernel_16043/167764205.py:4: UserWarning: FigureCanvasAgg is non-interactive, and thus cannot be shown
      fig.show()

![](hosp_only_ww_model_files/figure-commonmark/cell-10-output-3.png)

![](hosp_only_ww_model_files/figure-commonmark/cell-10-output-4.png)

![](hosp_only_ww_model_files/figure-commonmark/cell-10-output-5.png)

![](hosp_only_ww_model_files/figure-commonmark/cell-10-output-6.png)

![](hosp_only_ww_model_files/figure-commonmark/cell-10-output-7.png)

![](hosp_only_ww_model_files/figure-commonmark/cell-10-output-8.png)

![](hosp_only_ww_model_files/figure-commonmark/cell-10-output-9.png)
